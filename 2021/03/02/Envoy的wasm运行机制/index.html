<!DOCTYPE html>
<html lang=cn>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="1. 结论 每个工作线程之间的虚拟机是相互独立的。线程之间独立的虚拟机（配置是一样的），是Envoy的TLS机制实现的。部分的代码逻辑(详细的要看下面的代码分析)  auto callback &#x3D; [plugin, this](const Common::Wasm::WasmHandleSharedPtr&amp; base_wasm) { &#x2F;&#x2F; NB: the Slot set() call d">
<meta property="og:type" content="article">
<meta property="og:title" content="Envoy的wasm运行机制">
<meta property="og:url" content="https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="LJC博客">
<meta property="og:description" content="1. 结论 每个工作线程之间的虚拟机是相互独立的。线程之间独立的虚拟机（配置是一样的），是Envoy的TLS机制实现的。部分的代码逻辑(详细的要看下面的代码分析)  auto callback &#x3D; [plugin, this](const Common::Wasm::WasmHandleSharedPtr&amp; base_wasm) { &#x2F;&#x2F; NB: the Slot set() call d">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/wasm_context.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302171537548.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302172122218.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302173352881.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302172326136.png">
<meta property="article:published_time" content="2021-03-02T12:57:46.000Z">
<meta property="article:modified_time" content="2021-03-23T08:07:47.573Z">
<meta property="article:author" content="LJC">
<meta property="article:tag" content="Envoy">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/wasm_context.svg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Envoy的wasm运行机制</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="LJC博客" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/03/02/c-%E8%99%9A%E5%87%BD%E6%95%B0/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/03/02/lua%E7%9A%84iterator%E5%AE%9E%E7%8E%B0/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&text=Envoy的wasm运行机制"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&is_video=false&description=Envoy的wasm运行机制"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Envoy的wasm运行机制&body=Check out this article: https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&name=Envoy的wasm运行机制&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&t=Envoy的wasm运行机制"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BB%93%E8%AE%BA"><span class="toc-number">1.</span> <span class="toc-text">1. 结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9E%B6%E6%9E%84%E5%A6%82%E4%B8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 架构如下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. 源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Wasm%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E7%9A%84%E7%B1%BB%E5%9B%BE"><span class="toc-number">4.</span> <span class="toc-text">4. Wasm相关代码的类图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%B3%E4%BA%8EWasmFilter%E4%B8%AD%E7%9A%84onConfigure"><span class="toc-number">6.</span> <span class="toc-text">5. 关于WasmFilter中的onConfigure</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Envoy的wasm运行机制
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">LJC</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-03-02T12:57:46.000Z" itemprop="datePublished">2021-03-02</time>
        
        (Updated: <time datetime="2021-03-23T08:07:47.573Z" itemprop="dateModified">2021-03-23</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Envoy/" rel="tag">Envoy</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="1-结论"><a href="#1-结论" class="headerlink" title="1. 结论"></a>1. 结论</h2><ul>
<li><p>每个工作线程之间的虚拟机是相互独立的。线程之间独立的虚拟机（配置是一样的），是Envoy的TLS机制实现的。部分的代码逻辑(详细的要看下面的代码分析)</p>
<blockquote>
<p>auto callback = [plugin, this](const Common::Wasm::WasmHandleSharedPtr&amp; base_wasm) {</p>
<pre><code>// NB: the Slot set() call doesn&#39;t complete inline, so all arguments must outlive this call.
tls_slot_-&gt;set(
    [base_wasm,
     plugin](Event::Dispatcher&amp; dispatcher) -&gt; std::shared_ptr&lt;ThreadLocal::ThreadLocalObject&gt; &#123;
      if (!base_wasm) &#123;
        return nullptr;
      &#125;
      return std::static_pointer_cast&lt;ThreadLocal::ThreadLocalObject&gt;(
          Common::Wasm::getOrCreateThreadLocalWasm(base_wasm, plugin, dispatcher));
    &#125;);
</code></pre>
<p>  };</p>
</blockquote>
</li>
<li><p>同一个工作线程中，使用vm_id 和 vm_config.configuration和编译出来后的wasm字节码三个元素组合作为标志的。换言之，只有这三个元素一致才认为同一个线程中的虚拟机是相同的。如果仅仅是vm_id相同，其他有不一样的，在同一个线程中都不是属于同一个虚拟机。根据三个元素生成vm_key的使用如下：</p>
<blockquote>
<p>auto vm_key =</p>
<pre><code>    proxy_wasm::makeVmKey(vm_config.vm_id(), anyToBytes(vm_config.configuration()), code);
</code></pre>
</blockquote>
</li>
<li><p>每个wasm的虚拟机只有一个rootContext，如果配置了多个filters，使用的是同一个虚拟机，引用的rootContext是同一个对象。rootContext的生命周期和wasm虚拟机一样，因此这个可以作为一个计数器。因此每次请求（4层或7层), 都会生成一个Context作为上下文管理器，并且这个Context会引用rootContext。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/wasm_context.svg" alt="image"></p>
<p>​            </p>
<h2 id="2-架构如下"><a href="#2-架构如下" class="headerlink" title="2. 架构如下"></a>2. 架构如下</h2><p>在讨论Envoy的WASM架构前，先说一下沙箱技术。所谓的沙箱技术其实是一种隔离资源的方法，沙箱并不是一个独立的进程或者线程，可以理解为提供沙箱技术的框架，这个框架实现了ABI的兼容。假设我们编译出来的Wasm字节码也是一个也是一个库，这个库要被Envoy使用，需要有一个沙箱技术的框架，把这些Wasm的字节码加载到内存中去，并且在Envoy需要调用这个库的时候，框架就可以调用到这个库的代码。另外沙箱技术就可以做一些隔离了，比如fd、内存的限制都可以作为配置的一部分。这样可以有效的对不同的用户，做资源上的隔离，也可以达到安全的目的。</p>
<p>线程级别的vm隔离和vm_key的架构如下：</p>
<p>其中虚拟机vm是由类Wasm定义的，构造Wasm生成的对象就是一个虚拟机vm。</p>
<p><img src="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302171537548.png" alt="image-20210302171537548"></p>
<p>我们编写的Wasm Filter是如何被Envoy调用的呢？其实有两个关键库</p>
<ul>
<li>proxy-was-cpp-host: Envoy源码使用的，用于创建虚拟机和加载wasm code。</li>
<li>proxy-was-cpp-sdk： 编写Wasm Filter时候需要按照这个库的规范。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302172122218.png" alt="image-20210302172122218"></p>
<h2 id="3-源码分析"><a href="#3-源码分析" class="headerlink" title="3. 源码分析"></a>3. 源码分析</h2><p>如果我们在http_connection_manager的http_filters中添加了一个wasm的配置，如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http_filters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.filters.http.wasm</span></span><br><span class="line">    <span class="attr">typed_config:</span></span><br><span class="line">      <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/udpa.type.v1.TypedStruct</span></span><br><span class="line">      <span class="attr">type_url:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;something-bar&quot;</span></span><br><span class="line">          <span class="attr">root_id:</span> <span class="string">&quot;configuration_demo&quot;</span></span><br><span class="line">          <span class="attr">configuration:</span></span><br><span class="line">            <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">&quot;type.googleapis.com/google.protobuf.StringValue&quot;</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">|</span></span><br><span class="line">              <span class="string">&quot;111111111111111111111&quot;</span></span><br><span class="line">          <span class="attr">vm_config:</span></span><br><span class="line">            <span class="attr">runtime:</span> <span class="string">&quot;envoy.wasm.runtime.v8&quot;</span></span><br><span class="line">            <span class="attr">vm_id:</span> <span class="string">&quot;vm_id_foo&quot;</span></span><br><span class="line">            <span class="attr">code:</span></span><br><span class="line">              <span class="attr">local:</span></span><br><span class="line">                <span class="attr">filename:</span> <span class="string">&quot;../bazel-bin/envoy-wasm-demo/configuration_demo.wasm&quot;</span></span><br><span class="line">            <span class="attr">configuration:</span></span><br><span class="line">              <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">&quot;type.googleapis.com/google.protobuf.StringValue&quot;</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">|-</span></span><br><span class="line">                <span class="string">fasdfdafasdf</span></span><br></pre></td></tr></table></figure>

<p>这份配置在Envoy初始化的时候，是会执行代码Envoy::Extensions::HttpFilters::Wasm::FilterConfig::FilterConfig（下面简称为FilterConfig）。FilterConfig只会在配置加载的时候执行一次，为每个线程都创建一个wasm的虚拟机。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">FilterConfig::FilterConfig(<span class="keyword">const</span> envoy::extensions::filters::http::wasm::v3::Wasm&amp; config,</span><br><span class="line">                           Server::Configuration::FactoryContext&amp; context)</span><br><span class="line">    : tls_slot_(context.threadLocal().allocateSlot()) &#123;</span><br><span class="line">      </span><br><span class="line">  <span class="comment">// plugin_ 拥有原始的wasm配置的参数，包括runtime的配置   </span></span><br><span class="line">  plugin_ = <span class="built_in">std</span>::make_shared&lt;Common::Wasm::Plugin&gt;(</span><br><span class="line">      config.config().name(), config.config().root_id(), config.config().vm_config().vm_id(),</span><br><span class="line">      config.config().vm_config().runtime(),</span><br><span class="line">      Common::Wasm::anyToBytes(config.config().configuration()), config.config().fail_open(),</span><br><span class="line">      context.direction(), context.localInfo(), &amp;context.listenerMetadata());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> plugin = plugin_;</span><br><span class="line">  <span class="comment">// 回调函数callback,用于给每个线程都创建或获取一个Wasm的虚拟机（调用getOrCreateThreadLocalWasm实现）。</span></span><br><span class="line">  <span class="keyword">auto</span> callback = [plugin, <span class="keyword">this</span>](<span class="keyword">const</span> Common::Wasm::WasmHandleSharedPtr&amp; base_wasm) &#123;</span><br><span class="line">    <span class="comment">// NB: the Slot set() call doesn&#x27;t complete inline, so all arguments must outlive this call.</span></span><br><span class="line">    tls_slot_-&gt;<span class="built_in">set</span>(</span><br><span class="line">        [base_wasm,</span><br><span class="line">         plugin](Event::Dispatcher&amp; dispatcher) -&gt; <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ThreadLocal::ThreadLocalObject&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (!base_wasm) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">std</span>::static_pointer_cast&lt;ThreadLocal::ThreadLocalObject&gt;(</span><br><span class="line">              Common::Wasm::getOrCreateThreadLocalWasm(base_wasm, plugin, dispatcher));</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 根据配置文件的创建wasm</span></span><br><span class="line">  <span class="keyword">if</span> (!Common::Wasm::createWasm(</span><br><span class="line">          config.config().vm_config(), plugin_, context.scope().createScope(<span class="string">&quot;&quot;</span>),</span><br><span class="line">          context.clusterManager(), context.initManager(), context.dispatcher(), context.api(),</span><br><span class="line">          context.lifecycleNotifier(), remote_data_provider_, <span class="built_in">std</span>::move(callback))) &#123;</span><br><span class="line">    <span class="keyword">throw</span> Common::Wasm::WasmException(</span><br><span class="line">        fmt::format(<span class="string">&quot;Unable to create Wasm HTTP filter &#123;&#125;&quot;</span>, plugin-&gt;name_));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用Common::Was::createWasm最终会调用到CreateWasmInternal, 其代码如下（使用local模式加载wasm代码后精简）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">createWasmInternal</span><span class="params">(<span class="keyword">const</span> VmConfig&amp; vm_config, <span class="keyword">const</span> PluginSharedPtr&amp; plugin,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">const</span> Stats::ScopeSharedPtr&amp; scope,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Upstream::ClusterManager&amp; cluster_manager,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Init::Manager&amp; init_manager, Event::Dispatcher&amp; dispatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Api::Api&amp; api, Server::ServerLifecycleNotifier&amp; lifecycle_notifier,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Config::DataSource::RemoteAsyncDataProviderPtr&amp; remote_data_provider,</span></span></span><br><span class="line"><span class="function"><span class="params">                               CreateWasmCallback&amp;&amp; cb,</span></span></span><br><span class="line"><span class="function"><span class="params">                               CreateContextFn create_root_context_for_testing = <span class="literal">nullptr</span>)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// 获取一个EnvoyWasm对象</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    WasmExtension* getWasmExtension() &#123;</span></span><br><span class="line"><span class="comment">      static WasmExtension* extension = wasm_extension ? wasm_extension : new EnvoyWasm();</span></span><br><span class="line"><span class="comment">      return extension;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">auto</span> wasm_extension = getWasmExtension();</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> source, code;</span><br><span class="line">    <span class="comment">// 从本地读取wasm编译后的字节码</span></span><br><span class="line">    code = Config::DataSource::read(vm_config.code().local(), <span class="literal">true</span>, api);</span><br><span class="line">    source = Config::DataSource::getPath(vm_config.code().local())</span><br><span class="line">                 .value_or(code.empty() ? EMPTY_STRING : INLINE_STRING);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> complete_cb = [cb, vm_config, plugin, scope, &amp;cluster_manager, &amp;dispatcher,</span><br><span class="line">                      &amp;lifecycle_notifier, create_root_context_for_testing,</span><br><span class="line">                      wasm_extension](<span class="built_in">std</span>::<span class="built_in">string</span> code) -&gt; <span class="keyword">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (code.empty()) &#123;</span><br><span class="line">      cb(<span class="literal">nullptr</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据vm_id、vm的配置和wasm字节码生成一个vm_key,用于唯一标识虚拟机</span></span><br><span class="line">    <span class="keyword">auto</span> vm_key =</span><br><span class="line">        proxy_wasm::makeVmKey(vm_config.vm_id(), anyToBytes(vm_config.configuration()), code);</span><br><span class="line">    <span class="keyword">auto</span> wasm_factory = wasm_extension-&gt;wasmFactory();</span><br><span class="line">    proxy_wasm::WasmHandleFactory proxy_wasm_factory =</span><br><span class="line">        [&amp;vm_config, scope, &amp;cluster_manager, &amp;dispatcher, &amp;lifecycle_notifier,</span><br><span class="line">         wasm_factory](absl::string_view vm_key) -&gt; WasmHandleBaseSharedPtr &#123;</span><br><span class="line">      <span class="keyword">return</span> wasm_factory(vm_config, scope, cluster_manager, dispatcher, lifecycle_notifier,</span><br><span class="line">                          vm_key);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 创建虚拟机  </span></span><br><span class="line">    <span class="keyword">auto</span> wasm = proxy_wasm::createWasm(</span><br><span class="line">        vm_key, code, plugin, proxy_wasm_factory,</span><br><span class="line">        getCloneFactory(wasm_extension, dispatcher, create_root_context_for_testing),</span><br><span class="line">        vm_config.allow_precompiled());</span><br><span class="line">    Stats::ScopeSharedPtr create_wasm_stats_scope =</span><br><span class="line">        wasm_extension-&gt;lockAndCreateStats(scope, plugin);</span><br><span class="line">    wasm_extension-&gt;onEvent(toWasmEvent(wasm), plugin);</span><br><span class="line">    <span class="keyword">if</span> (!wasm || wasm-&gt;wasm()-&gt;isFailed()) &#123;</span><br><span class="line">      ENVOY_LOG_TO_LOGGER(Envoy::Logger::Registry::getLog(Envoy::Logger::Id::wasm), trace,</span><br><span class="line">                          <span class="string">&quot;Unable to create Wasm&quot;</span>);</span><br><span class="line">      cb(<span class="literal">nullptr</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建虚拟机成功后，执行tls的回调函数，使的每个线程都拥有一个拷贝出来的虚拟机。</span></span><br><span class="line">    cb(<span class="built_in">std</span>::static_pointer_cast&lt;WasmHandle&gt;(wasm));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> complete_cb(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>proxy_wasm::createWasm调用的是proxy-wasm-cpp-host库中的函数createWasm，具体代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;WasmHandleBase&gt; <span class="title">createWasm</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> vm_key, <span class="built_in">std</span>::<span class="built_in">string</span> code,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;PluginBase&gt; plugin,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           WasmHandleFactory factory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           WasmHandleCloneFactory clone_factory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">bool</span> allow_precompiled)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;WasmHandleBase&gt; wasm_handle;</span><br><span class="line">  &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">guard</span><span class="params">(base_wasms_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!base_wasms) &#123;</span><br><span class="line">      base_wasms = <span class="keyword">new</span> <span class="built_in">std</span>::remove_reference&lt;<span class="keyword">decltype</span>(*base_wasms)&gt;::type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果存在同一个vm_key相同的虚拟机，直接返回即可。否则就要创建一个新的虚拟机。</span></span><br><span class="line">    <span class="keyword">auto</span> it = base_wasms-&gt;find(vm_key);</span><br><span class="line">    <span class="keyword">if</span> (it != base_wasms-&gt;end()) &#123;</span><br><span class="line">      wasm_handle = it-&gt;second.lock();</span><br><span class="line">      <span class="keyword">if</span> (!wasm_handle) &#123;</span><br><span class="line">        base_wasms-&gt;erase(it);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wasm_handle) &#123;</span><br><span class="line">      <span class="keyword">return</span> wasm_handle;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据vm_key去创建一个虚拟机。这个factory就是EnvoyWasm对象中的factory.</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     proxy_wasm::WasmHandleFactory proxy_wasm_factory =</span></span><br><span class="line"><span class="comment">        [&amp;vm_config, scope, &amp;cluster_manager, &amp;dispatcher, &amp;lifecycle_notifier,</span></span><br><span class="line"><span class="comment">         wasm_factory](absl::string_view vm_key) -&gt; WasmHandleBaseSharedPtr &#123;</span></span><br><span class="line"><span class="comment">      return wasm_factory(vm_config, scope, cluster_manager, dispatcher, lifecycle_notifier,</span></span><br><span class="line"><span class="comment">                          vm_key);</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    wasm_handle = factory(vm_key);</span><br><span class="line">    <span class="keyword">if</span> (!wasm_handle) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    (*base_wasms)[vm_key] = wasm_handle;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 新创建出来的虚拟机，需要执行下面的一系列初始化的过程。</span></span><br><span class="line">  <span class="keyword">if</span> (!wasm_handle-&gt;wasm()-&gt;initialize(code, allow_precompiled)) &#123;</span><br><span class="line">    wasm_handle-&gt;wasm()-&gt;fail(FailState::UnableToInitializeCode, <span class="string">&quot;Failed to initialize Wasm code&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//配置预检查。clone_factory克隆一个wasm出来去执行相关的配置</span></span><br><span class="line">  <span class="comment">// getCloneFactory(wasm_extension, dispatcher, create_root_context_for_testing)</span></span><br><span class="line">  <span class="keyword">auto</span> configuration_canary_handle = clone_factory(wasm_handle);</span><br><span class="line">  <span class="keyword">if</span> (!configuration_canary_handle) &#123;</span><br><span class="line">    wasm_handle-&gt;wasm()-&gt;fail(FailState::UnableToCloneVM, <span class="string">&quot;Failed to clone Base Wasm&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!configuration_canary_handle-&gt;wasm()-&gt;initialize(code, allow_precompiled)) &#123;</span><br><span class="line">    wasm_handle-&gt;wasm()-&gt;fail(FailState::UnableToInitializeCode, <span class="string">&quot;Failed to initialize Wasm code&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> root_context = configuration_canary_handle-&gt;wasm()-&gt;start(plugin);</span><br><span class="line">  <span class="keyword">if</span> (!root_context) &#123;</span><br><span class="line">    configuration_canary_handle-&gt;wasm()-&gt;fail(FailState::StartFailed, <span class="string">&quot;Failed to start base Wasm&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!configuration_canary_handle-&gt;wasm()-&gt;configure(root_context, plugin)) &#123;</span><br><span class="line">    configuration_canary_handle-&gt;wasm()-&gt;fail(FailState::ConfigureFailed,</span><br><span class="line">                                              <span class="string">&quot;Failed to configure base Wasm plugin&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  configuration_canary_handle-&gt;kill();</span><br><span class="line">  <span class="keyword">return</span> wasm_handle;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>在createWasm创建虚拟机的工厂函数的实现是：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WasmHandleExtensionFactory <span class="title">EnvoyWasm::wasmFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [](<span class="keyword">const</span> VmConfig vm_config, <span class="keyword">const</span> Stats::ScopeSharedPtr&amp; scope,</span><br><span class="line">            Upstream::ClusterManager&amp; cluster_manager, Event::Dispatcher&amp; dispatcher,</span><br><span class="line">            Server::ServerLifecycleNotifier&amp; lifecycle_notifier,</span><br><span class="line">            absl::string_view vm_key) -&gt; WasmHandleBaseSharedPtr &#123;</span><br><span class="line">    <span class="comment">// 根据插件的配置去创建一个虚拟机. 使用的类是Wasm</span></span><br><span class="line">    <span class="keyword">auto</span> wasm = <span class="built_in">std</span>::make_shared&lt;Wasm&gt;(vm_config.runtime(), vm_config.vm_id(),</span><br><span class="line">                                       anyToBytes(vm_config.configuration()), vm_key, scope,</span><br><span class="line">                                       cluster_manager, dispatcher);</span><br><span class="line">    wasm-&gt;initializeLifecycle(lifecycle_notifier);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::static_pointer_cast&lt;WasmHandleBase&gt;(<span class="built_in">std</span>::make_shared&lt;WasmHandle&gt;(<span class="built_in">std</span>::move(wasm)));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后真正创建虚拟机的代码是：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WasmVmPtr <span class="title">createWasmVm</span><span class="params">(absl::string_view runtime, <span class="keyword">const</span> Stats::ScopeSharedPtr&amp; scope)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  部分代码被省略；std::unique_ptr&lt;WasmVm&gt; createV8Vm() &#123; return std::make_unique&lt;V8&gt;(); &#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ENVOY_WASM_V8)</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (runtime == WasmRuntimeNames::get().V8) &#123;</span><br><span class="line">    <span class="keyword">auto</span> wasm = proxy_wasm::createV8Vm();</span><br><span class="line">    wasm-&gt;integration() = getWasmExtension()-&gt;createEnvoyWasmVmIntegration(scope, runtime, <span class="string">&quot;v8&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> wasm;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-Wasm相关代码的类图"><a href="#4-Wasm相关代码的类图" class="headerlink" title="4. Wasm相关代码的类图"></a>4. Wasm相关代码的类图</h2><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302173352881.png" alt="image-20210302173352881"></h2><ul>
<li><p>EnvoyWasm可以理解为一个工厂类，里面定义了如何创建一个虚拟机；如何根据一个虚拟机（base_vm)去克隆出另外一个虚拟机（代码层面就是拷贝构造）。</p>
</li>
<li><p>Wasm就是虚拟机的类。里面定义虚拟机的所有操作。</p>
</li>
<li><p>V8是谷歌开源的js和wasm的引擎，是虚拟机的运行时。Wasm内部有个成员wasm_vm_引用的就是虚拟机的运行时。Envoy支持三种运行时：V8，Wavm，nullVm</p>
</li>
<li><p>WasmHandle里面引用的虚拟机Wasm类构造出来的对象，另外WasmHandle继承于ThreadLocalObject,这样这个对象就可以多个线程之前独立了。这是实现每个线程的虚拟机之前隔离的重要手段。</p>
</li>
<li><p>黄色的类是Envoy的源码中的。粉色的类是proxy-wasm-cpp-host的源码中的。</p>
</li>
</ul>
<h2 id="5-关于WasmFilter中的onConfigure"><a href="#5-关于WasmFilter中的onConfigure" class="headerlink" title="5. 关于WasmFilter中的onConfigure"></a>5. 关于WasmFilter中的onConfigure</h2><p>编写WasmFilter的时候，RootContext的onConfigure会被执行多次（如果同一个线程中存在多个同一个vm（三个元素显通才能认为是同一个vm）的配置）。</p>
<p><img src="https://raw.githubusercontent.com/leejiancai/image_repo/master/img/image-20210302172326136.png" alt="image-20210302172326136"></p>
<p>Envoy中调用on_configure会执行到RootContext的onConfigure。但是onConfigure的参数是插件plugin的配置字符串的大小。如果我们希望拿vm_config的配置，有两个做法（当然也可以把配置放在plugin中）：</p>
<ul>
<li>插件的configuration和vm的configuration一致即可。</li>
<li>插件的configuration的字符串长度大于vm的configuration。</li>
</ul>
<blockquote>
<p>auto result =<br>      wasm_-&gt;on_configure_(this, id_, static_cast<uint32_t>(plugin-&gt;plugin_configuration_.size()))<br>          .u64_ != 0;</p>
</blockquote>
<p>小结：我们的配置最好放在plugin的configuration的字段中，而不是用vm_config中的configuration。</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
  </div>
  <br/>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_pv">【本站总访问量】<span id="busuanzi_value_site_pv"></span>次</span>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BB%93%E8%AE%BA"><span class="toc-number">1.</span> <span class="toc-text">1. 结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9E%B6%E6%9E%84%E5%A6%82%E4%B8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 架构如下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. 源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Wasm%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E7%9A%84%E7%B1%BB%E5%9B%BE"><span class="toc-number">4.</span> <span class="toc-text">4. Wasm相关代码的类图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%B3%E4%BA%8EWasmFilter%E4%B8%AD%E7%9A%84onConfigure"><span class="toc-number">6.</span> <span class="toc-text">5. 关于WasmFilter中的onConfigure</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&text=Envoy的wasm运行机制"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&is_video=false&description=Envoy的wasm运行机制"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Envoy的wasm运行机制&body=Check out this article: https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=Envoy的wasm运行机制"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&name=Envoy的wasm运行机制&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://leejiancai.github.io/2021/03/02/Envoy%E7%9A%84wasm%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/&t=Envoy的wasm运行机制"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2099
    LJC
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GB2KNQXDVP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-GB2KNQXDVP');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'https-leejiancai-github-io';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
